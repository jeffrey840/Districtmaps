<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GeoJSON, Turf.js, and Google Maps Example</title>
  <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADd7NKHfGXY1FLZn4z260m0pwnhFcA1gE&libraries=places"></script>
  <style>
    body {
      display: flex;
      justify-content: space-between;
    }
    #searchContainer {
      width: 30%;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }
    #map {
      height: 500px;
      width: 70%;
    }
    #searchBox, #checkLocationBtn {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
<div id="searchContainer">
  <input id="searchBox" type="text" placeholder="Enter an address...">
  <button id="checkLocationBtn">Check My Location</button>
</div>
<div id="map"></div>
<script>
  let map, marker, geoJsonData;

  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 12,
      center: { lat: 29.7604, lng: -95.3698 } // Default center (e.g., Houston, TX)
    });

    // Fetch and display GeoJSON overlay
    fetchAndProcessGeoJson('https://raw.githubusercontent.com/jeffrey840/zipcode_2/main/Hcc_districts_Geojson/merged_districts.geojson');
  }

  async function fetchAndProcessGeoJson(url) {
    try {
      const response = await fetch(url);
      geoJsonData = await response.json();
      if (geoJsonData && geoJsonData.features) {
        map.data.addGeoJson(geoJsonData);
      } else {
        console.error("GeoJSON data is invalid.");
      }
    } catch (error) {
      console.error("Error fetching GeoJSON data:", error);
    }
  }

  function checkPointInGeoJsonPolygon(pointCoordinates) {

    if (!Array.isArray(pointCoordinates) || pointCoordinates.length !== 2 ||
            typeof pointCoordinates[0] !== 'number' || typeof pointCoordinates[1] !== 'number') {
      console.error("Invalid point coordinates:", pointCoordinates);
      alert("Invalid point coordinates. Cannot check location.");
      return;
    }

    const polygon = geoJsonData.features[0].geometry;
    const point = turf.point(pointCoordinates);
    const isInside = turf.booleanPointInPolygon(point, polygon);

    if (!marker) {
      // Initialize the marker when first needed
      marker = new google.maps.Marker({
        position: { lat: pointCoordinates[1], lng: pointCoordinates[0] },
        map: map,
        title: 'Point Location'
      });
    } else {
      // Update the marker's position
      marker.setPosition({ lat: pointCoordinates[1], lng: pointCoordinates[0] });
    }

    alert(isInside ? "is within bounds" : "outside bounds");
  }

  function getUserLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        const pointCoordinates = [position.coords.longitude, position.coords.latitude];
        if (geoJsonData) {
          checkPointInGeoJsonPolygon(geoJsonData, pointCoordinates);
        } else {
          alert('GeoJSON data is not yet loaded. Please try again.');
        }
      }, () => {
        alert('Error getting your location.');
      });
    } else {
      alert('Geolocation is not supported by this browser.');
    }
  }

  async function handleSearchInput(e) {
    if (e.key === 'Enter') {
      const address = document.getElementById('searchBox').value;
      const geocoder = new google.maps.Geocoder();

      try {
        const location = await geocodeAddress(geocoder, address);
        const pointCoordinates = [location.lng(), location.lat()];

        // Ensure GeoJSON data is loaded before proceeding
        if (geoJsonData) {
          checkPointInGeoJsonPolygon(geoJsonData, pointCoordinates);
        } else {
          alert("GeoJSON data is not yet loaded. Please try again.");
        }
      } catch (error) {
        alert(error);
      }
    }
  }

  async function geocodeAddress(geocoder, address) {
    return new Promise((resolve, reject) => {
      geocoder.geocode({ 'address': address }, (results, status) => {
        if (status === 'OK') {
          resolve(results[0].geometry.location);
        } else {
          reject('Geocode was not successful for the following reason: ' + status);
        }
      });
    });
  }

  document.getElementById('checkLocationBtn').addEventListener('click', getUserLocation);
  document.getElementById('searchBox').addEventListener('keydown', handleSearchInput);

  initMap(); // Initialize map
</script>
</body>
</html>
