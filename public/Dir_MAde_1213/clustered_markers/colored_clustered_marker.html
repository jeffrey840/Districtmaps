<!doctype html>
<html>
<head>
	<title>Marker Clustering</title>
	<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
	<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</head>
<style>
    html,body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    #map {
        height: 100%;
    }
</style>
<body>
<div id="map"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2Z4Lk0QfR6QngDRAQM6k0mzP7NJAu1vs&callback=initMap" async defer></script>

<script type="module">
	import { MarkerClusterer, DefaultRenderer } from "https://cdn.skypack.dev/@googlemaps/markerclusterer@2.3.1";

	class CustomRenderer extends DefaultRenderer {
		render(cluster, stats) {
			const count = cluster.markers.length; // Ensure this matches the library's API
			const position = cluster.position; // Or however the position is obtained

			const color = "#bdaf33"; // Example: Green color for clusters

			const svg = `<svg fill="${color}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240">
				<circle cx="120" cy="120" opacity=".11" r="10" />
                <circle cx="120" cy="120" opacity=".10" r="20" />
                <circle cx="120" cy="120" opacity=".9" r="30" />
				<circle cx="120" cy="120" opacity=".8" r="40" />
                <circle cx="120" cy="120" opacity=".7" r="50" />
                <circle cx="120" cy="120" opacity=".6" r="60" />
                <circle cx="120" cy="120" opacity=".5" r="70" />
                <circle cx="120" cy="120" opacity=".2" r="90" />
                <circle cx="120" cy="120" opacity=".1" r="100" />
                <text x="50%" y="50%" fill="#fff" text-anchor="middle" font-size="50" dominant-baseline="middle">${count}</text>
            </svg>`;

			return new google.maps.Marker({
				position,
				icon: {
					url: `data:image/svg+xml;base64,${btoa(svg)}`,
					scaledSize: new google.maps.Size(45, 45),
				},
				label: {
					text: String(count),
					color: "rgba(255,255,255,0.9)",
					fontSize: "16px",
				},
				zIndex: 1000 + count,
			});
		}
	}

	async function initMap() {
		const map = new google.maps.Map(document.getElementById("map"), {
			zoom: 10,
			center: { lat: 29.7604, lng: -95.787 },
			mapId: "DEMO_MAP_ID",
		});

		const infoWindow = new google.maps.InfoWindow({ content: "", disableAutoPan: true });

		const githubURL = 'https://raw.githubusercontent.com/jeffrey840/zipcode_2/main/district_data/combined_1_zillow_listings.json';
		const response = await fetch(githubURL);
		const properties = await response.json();

		const markers = properties.map(property => {
			const position = { lat: property.latitude, lng: property.longitude };


			const marker = new google.maps.Marker({ position, map });

			marker.addListener("click", () => {
				const content = `
					<div>
						<h3>${property.address}</h3>
						<p>Price: $${property.price}</p>
						<p>Type: ${property.propertyType}</p>
						<a href="https://www.zillow.com${property.detailUrl}" target="_blank">View on Zillow</a>
					</div>
				`;
				infoWindow.setContent(content);
				infoWindow.open(map, marker);
			});

			return marker;
		});

		// Use the custom renderer for clusters
		new MarkerClusterer({ markers, map, renderer: new CustomRenderer() });
	}

	initMap();
</script>

</body>
</html>
