<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Display Listings in District 5 with GitHub JSON</title>
  <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2Z4Lk0QfR6QngDRAQM6k0mzP7NJAu1vs&callback=initialize" async defer></script>
  <style>
    #map {
      height: 500px;
      width: 100%;
    }
  </style>
</head>
<body>
<div id="map"></div>
<script>
  let map;
  let markers = []; // Array to hold map markers
  let fetchController;
  let currentDistrict = '5';
  const districtGeoJsonUrl = "https://raw.githubusercontent.com/jeffrey840/zipcode_2/main/Hcc_districts_Geojson/district_5.geojson";

  function initialize() {
    console.log('Initializing map...');
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 12,
      center: { lat: 29.842912, lng: -95.323 } // Adjust as needed for District 5
    });
    loadDistrictData(currentDistrict); // Load District 5 data initially
  }

  async function loadDistrictData(districtNumber) {
    console.log(`Loading data for District ${districtNumber}`);
    if (fetchController) fetchController.abort(); // Abort any ongoing fetch requests
    fetchController = new AbortController(); // Create a new controller for the new request

    clearMarkers(); // Clear existing markers before loading new data
    map.data.forEach(feature => map.data.remove(feature)); // Clear existing GeoJSON overlays

    try {
      const districtGeoJson = await fetchGeoJson(districtGeoJsonUrl, fetchController.signal);
      map.data.addGeoJson(districtGeoJson);
      map.data.setStyle({
        fillColor: 'blue',
        strokeWeight: 1
      });

      // Fetch and display houses for District 5
      await fetchHouses(districtNumber);
    } catch (error) {
      console.error('Error during fetch:', error);
    }
  }

  async function fetchHouses(districtNumber) {
    const url = `https://raw.githubusercontent.com/jeffrey840/zipcode_2/main/district_data/combined_${districtNumber}_zillow_listings.json`;

    try {
      const response = await fetch(url);
      const listings = await response.json();

      console.log(`All listings from District ${districtNumber}:`, listings); // Log all listings

      if (listings && listings.length > 0) {
        displayHousesOnMap(listings, districtNumber); // Display all listings on map
      }
    } catch (error) {
      console.error('Error fetching houses:', error);
    }
  }

  function displayHousesOnMap(listings, districtNumber) {
    if (currentDistrict !== districtNumber) {
      console.log(`Not displaying houses for District ${districtNumber}.`);
      return;
    }

    const redMarker = {
      path: google.maps.SymbolPath.CIRCLE,
      fillColor: 'red',
      fillOpacity: 1,
      scale: 5,
      strokeColor: 'red',
      strokeWeight: 1
    };

    listings.forEach(listing => {
      if (listing.latitude && listing.longitude) { // Only display listings with valid coordinates
        const marker = new google.maps.Marker({
          position: { lat: listing.latitude, lng: listing.longitude },
          map: map,
          icon: redMarker
        });
        markers.push(marker); // Add marker to the array
      }
    });
  }

  function clearMarkers() {
    console.log('Clearing markers...');
    markers.forEach(marker => marker.setMap(null));
    markers = [];
  }

  async function fetchGeoJson(url, signal) {
    try {
      const response = await fetch(url, { signal });
      return await response.json();
    } catch (error) {
      console.error("Error fetching GeoJSON data:", error);
      throw error; // Rethrow to handle in the calling function
    }
  }

</script>
</body>
</html>
